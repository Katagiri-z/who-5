<!DOCTYPE html>
<html lang="ja" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Well-being Tracker（WHO-5）</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script>
        if (localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 p-4">
    <div class="max-w-lg mx-auto bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg">
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-2xl font-bold">Well-being Tracker（WHO-5）</h1>
            <button id="themeToggle" class="px-3 py-1 rounded-lg border dark:border-gray-500">🌙</button>
        </div>
        <form id="who5Form" class="space-y-4">
            <p>過去2週間の状態について、0（全くない）～5（いつもそうだ）で評価してください。</p>
            <div id="questions" class="space-y-2"></div>
            <button type="submit" class="w-full bg-blue-500 text-white p-2 rounded-lg">記録する</button>
        </form>
        <div class="mt-6">
            <h2 class="text-xl font-semibold">記録履歴</h2>
            <canvas id="chart" class="mt-4"></canvas>
            <ul id="history" class="mt-4 space-y-2"></ul>
            <div class="flex space-x-2 mt-4">
                <button id="clearAppData" class="flex-1 bg-red-500 text-white p-2 rounded-lg">このアプリの記録を削除</button>
                <button id="exportCSV" class="flex-1 bg-green-500 text-white p-2 rounded-lg" title="Excelで文字化けしにくいUTF-8(BOM)で出力">CSVエクスポート</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const themeToggle = document.getElementById('themeToggle');
        themeToggle.addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
        });

        const questions = [
            "活力に満ちていた",
            "落ち着いてリラックスできていた",
            "積極的に物事に取り組めた",
            "日常生活に満足していた",
            "前向きな気分で過ごせた"
        ];

        const questionsDiv = document.getElementById('questions');
        questions.forEach((q, i) => {
            const div = document.createElement('div');
            div.innerHTML = `<label>${q}</label><input type='number' min='0' max='5' class='w-full border rounded p-1 dark:bg-gray-700 dark:border-gray-500' id='q${i}' required>`;
            questionsDiv.appendChild(div);
        });

        const ctx = document.getElementById('chart').getContext('2d');
        let chart = new Chart(ctx, {
            type: 'line',
            data: { labels: [], datasets: [{ label: 'WHO-5 スコア', data: [], fill: false, borderColor: 'blue' }] },
            options: { responsive: true, scales: { y: { min: 0, max: 25 } } }
        });

        const historyList = document.getElementById('history');
        let history = JSON.parse(localStorage.getItem('who5History') || '[]');

        function getEvaluation(score) {
            if (score >= 13) return "良好な状態";
            else if (score >= 10) return "やや注意（改善の余地あり）";
            else return "要注意（支援が必要かもしれません）";
        }

        function updateHistory() {
            historyList.innerHTML = '';
            chart.data.labels = history.map(h => h.date);
            chart.data.datasets[0].data = history.map(h => h.score);
            chart.update();
            history.forEach(h => {
                const li = document.createElement('li');
                li.textContent = `${h.date}: ${h.score}点 - ${getEvaluation(h.score)}`;
                historyList.appendChild(li);
            });
        }

        updateHistory();

        document.getElementById('who5Form').addEventListener('submit', e => {
            e.preventDefault();
            const score = questions.reduce((sum, _, i) => sum + parseInt(document.getElementById(`q${i}`).value), 0);
            const today = new Date().toLocaleDateString();
            history.push({ date: today, score });
            localStorage.setItem('who5History', JSON.stringify(history));
            updateHistory();
            alert(`今回のスコア: ${score}点\n評価: ${getEvaluation(score)}`);
            e.target.reset();
        });

        document.getElementById('clearAppData').addEventListener('click', () => {
            if (confirm('本当にこのアプリの記録を削除しますか？')) {
                localStorage.removeItem('who5History');
                history = [];
                updateHistory();
                alert('記録を削除しました。');
            }
        });

        // ---- CSVエクスポート（Excelで文字化けしにくいUTF-8 with BOM + CRLF） ----
        document.getElementById('exportCSV').addEventListener('click', () => {
            if (history.length === 0) {
                alert('記録がありません');
                return;
            }
            const header = ['日付','スコア','評価'];
            const rows = history.map(h => [h.date, String(h.score), getEvaluation(h.score)]);
            const csvArray = [header, ...rows]
              .map(cols => cols.map(v => String(v).replaceAll('"','""')).map(v => /[",\n\r]/.test(v) ? `"${v}"` : v).join(','))
              .join('\r\n');
            // UTF-8 BOM を先頭に付ける
            const BOM = new Uint8Array([0xEF,0xBB,0xBF]);
            const blob = new Blob([BOM, csvArray], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'who5_records.csv';
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        });
    </script>
</body>
</html>
