<!DOCTYPE html>
<html lang="ja" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Well-being Trackerï¼ˆWHO-5ï¼‰</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script>
        if (localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 p-4">
    <div class="max-w-lg mx-auto bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg">
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-2xl font-bold">Well-being Trackerï¼ˆWHO-5ï¼‰</h1>
            <button id="themeToggle" class="px-3 py-1 rounded-lg border dark:border-gray-500">ğŸŒ™</button>
        </div>
        <form id="who5Form" class="space-y-4">
            <p>éå»2é€±é–“ã®çŠ¶æ…‹ã«ã¤ã„ã¦ã€0ï¼ˆå…¨ããªã„ï¼‰ï½5ï¼ˆã„ã¤ã‚‚ãã†ã ï¼‰ã§è©•ä¾¡ã—ã¦ãã ã•ã„ã€‚</p>
            <div id="questions" class="space-y-2"></div>
            <button type="submit" class="w-full bg-blue-500 text-white p-2 rounded-lg">è¨˜éŒ²ã™ã‚‹</button>
        </form>
        <div class="mt-6">
            <h2 class="text-xl font-semibold">è¨˜éŒ²å±¥æ­´</h2>
            <canvas id="chart" class="mt-4"></canvas>
            <ul id="history" class="mt-4 space-y-2"></ul>
            <div class="flex space-x-2 mt-4">
                <button id="clearAppData" class="flex-1 bg-red-500 text-white p-2 rounded-lg">ã“ã®ã‚¢ãƒ—ãƒªã®è¨˜éŒ²ã‚’å‰Šé™¤</button>
                <button id="exportCSV" class="flex-1 bg-green-500 text-white p-2 rounded-lg" title="Excelã§æ–‡å­—åŒ–ã‘ã—ã«ãã„UTF-8(BOM)ã§å‡ºåŠ›">CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const themeToggle = document.getElementById('themeToggle');
        themeToggle.addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
        });

        const questions = [
            "æ´»åŠ›ã«æº€ã¡ã¦ã„ãŸ",
            "è½ã¡ç€ã„ã¦ãƒªãƒ©ãƒƒã‚¯ã‚¹ã§ãã¦ã„ãŸ",
            "ç©æ¥µçš„ã«ç‰©äº‹ã«å–ã‚Šçµ„ã‚ãŸ",
            "æ—¥å¸¸ç”Ÿæ´»ã«æº€è¶³ã—ã¦ã„ãŸ",
            "å‰å‘ããªæ°—åˆ†ã§éã”ã›ãŸ"
        ];

        const questionsDiv = document.getElementById('questions');
        questions.forEach((q, i) => {
            const div = document.createElement('div');
            div.innerHTML = `<label>${q}</label><input type='number' min='0' max='5' class='w-full border rounded p-1 dark:bg-gray-700 dark:border-gray-500' id='q${i}' required>`;
            questionsDiv.appendChild(div);
        });

        const ctx = document.getElementById('chart').getContext('2d');
        let chart = new Chart(ctx, {
            type: 'line',
            data: { labels: [], datasets: [{ label: 'WHO-5 ã‚¹ã‚³ã‚¢', data: [], fill: false, borderColor: 'blue' }] },
            options: { responsive: true, scales: { y: { min: 0, max: 25 } } }
        });

        const historyList = document.getElementById('history');
        let history = JSON.parse(localStorage.getItem('who5History') || '[]');

        function getEvaluation(score) {
            if (score >= 13) return "è‰¯å¥½ãªçŠ¶æ…‹";
            else if (score >= 10) return "ã‚„ã‚„æ³¨æ„ï¼ˆæ”¹å–„ã®ä½™åœ°ã‚ã‚Šï¼‰";
            else return "è¦æ³¨æ„ï¼ˆæ”¯æ´ãŒå¿…è¦ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ï¼‰";
        }

        function updateHistory() {
            historyList.innerHTML = '';
            chart.data.labels = history.map(h => h.date);
            chart.data.datasets[0].data = history.map(h => h.score);
            chart.update();
            history.forEach(h => {
                const li = document.createElement('li');
                li.textContent = `${h.date}: ${h.score}ç‚¹ - ${getEvaluation(h.score)}`;
                historyList.appendChild(li);
            });
        }

        updateHistory();

        document.getElementById('who5Form').addEventListener('submit', e => {
            e.preventDefault();
            const score = questions.reduce((sum, _, i) => sum + parseInt(document.getElementById(`q${i}`).value), 0);
            const today = new Date().toLocaleDateString();
            history.push({ date: today, score });
            localStorage.setItem('who5History', JSON.stringify(history));
            updateHistory();
            alert(`ä»Šå›ã®ã‚¹ã‚³ã‚¢: ${score}ç‚¹\nè©•ä¾¡: ${getEvaluation(score)}`);
            e.target.reset();
        });

        document.getElementById('clearAppData').addEventListener('click', () => {
            if (confirm('æœ¬å½“ã«ã“ã®ã‚¢ãƒ—ãƒªã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                localStorage.removeItem('who5History');
                history = [];
                updateHistory();
                alert('è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚');
            }
        });

        // ---- CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆExcelã§æ–‡å­—åŒ–ã‘ã—ã«ãã„UTF-8 with BOM + CRLFï¼‰ ----
        document.getElementById('exportCSV').addEventListener('click', () => {
            if (history.length === 0) {
                alert('è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            const header = ['æ—¥ä»˜','ã‚¹ã‚³ã‚¢','è©•ä¾¡'];
            const rows = history.map(h => [h.date, String(h.score), getEvaluation(h.score)]);
            const csvArray = [header, ...rows]
              .map(cols => cols.map(v => String(v).replaceAll('"','""')).map(v => /[",\n\r]/.test(v) ? `"${v}"` : v).join(','))
              .join('\r\n');
            // UTF-8 BOM ã‚’å…ˆé ­ã«ä»˜ã‘ã‚‹
            const BOM = new Uint8Array([0xEF,0xBB,0xBF]);
            const blob = new Blob([BOM, csvArray], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'who5_records.csv';
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        });
    </script>
</body>
</html>
