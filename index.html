<!DOCTYPE html>
<html lang="ja" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Well-being Tracker（WHO-5 ＜1998年版の日本語訳＞）</title>
  <meta name="description" content="WHO-5（日本語版）の正式文言でウェルビーイングを日々記録し、グラフ・CSV・リマインド（2週間）に対応したモバイル向けWebアプリ。" />
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script>
    // 初期テーマ（ユーザー設定 or OS設定）
    try {
      const saved = localStorage.getItem('theme');
      if (saved === 'dark' || (!saved && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
    } catch {}
  </script>
  <style>
    html, body { height: 100%; }
    .sr { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }
  </style>
</head>
<body class="min-h-screen bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100">
  <!-- リマインド・バー -->
  <div id="reminderBar" class="hidden sticky top-0 z-20 bg-amber-100 dark:bg-amber-900 text-amber-900 dark:text-amber-100 border-b border-amber-300 dark:border-amber-700">
    <div class="max-w-xl mx-auto px-4 py-2 flex items-center gap-3">
      <span>前回の記録から2週間以上経過しています。新しい記録を追加しませんか？</span>
      <button id="reminderClose" class="ml-auto px-3 py-1 rounded-lg bg-amber-200/70 dark:bg-amber-800/70">閉じる</button>
      <button id="reminderGo" class="px-3 py-1 rounded-lg bg-black text-white">記録する</button>
    </div>
  </div>

  <!-- Header -->
  <header class="sticky top-0 z-10 bg-white/90 dark:bg-gray-800/90 backdrop-blur border-b border-gray-200 dark:border-gray-700">
    <div class="max-w-xl mx-auto px-4 py-3 flex items-center gap-3">
      <svg class="w-7 h-7" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M3 3v18h18"/><path d="M19 19V9l-5 5-4-4-7 7"/></svg>
      <div class="flex-1">
        <h1 class="text-xl font-bold">Well-being Tracker（WHO-5）</h1>
        <p class="text-sm text-gray-600 dark:text-gray-300">0–25点（百分率0–100）。正式文言・履歴・CSV・2週間リマインド。</p>
      </div>
      <button id="btn-theme" class="px-3 py-2 text-sm rounded-xl bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600" title="テーマ切替">🌙</button>
    </div>
  </header>

  <main class="max-w-xl mx-auto px-4 pb-24">
    <!-- 注意書き -->
    <section class="mt-4 bg-white dark:bg-gray-800 rounded-2xl shadow p-4">
      <h2 class="text-lg font-bold mb-2">WHO-5 日本語版（1998年版の翻訳文言）</h2>
      <p class="text-sm text-gray-700 dark:text-gray-300">以下の5つの各項目について、<strong>最近2週間</strong>のあなたの状態に最も近いものを選んでください。数値が高いほど精神的健康状態が高いことを示します。</p>
      <ul class="list-decimal ml-5 mt-3 space-y-1 text-sm">
        <li>明るく，楽しい気分で過ごした。</li>
        <li>落ち着いた、リラックスした気分で過ごした。</li>
        <li>意欲的で，活動的に過ごした。</li>
        <li>ぐっすりと休め，気持ちよくめざめた。</li>
        <li>日常生活の中に，興味のあることがたくさんあった。</li>
      </ul>
      <div class="mt-3 text-sm text-gray-700 dark:text-gray-300">
        <p class="font-semibold">回答オプション（0–5）</p>
        <p>0 = まったくない ／ 1 = ほんのたまに ／ 2 = 半分以下の期間を ／ 3 = 半分以上の期間を ／ 4 = ほとんどいつも ／ 5 = いつも</p>
      </div>
    </section>

    <!-- 入力カード -->
    <section class="mt-4 bg-white dark:bg-gray-800 rounded-2xl shadow p-4">
      <div class="flex items-center gap-2 mb-3">
        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
        <label for="date" class="text-base font-semibold">記録日</label>
      </div>
      <input id="date" type="date" class="w-full p-3 rounded-xl border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-lg" />

      <h2 class="mt-6 text-lg font-bold">設問（0〜5）</h2>
      <div id="who5-fields" class="mt-2 space-y-3"></div>

      <!-- Summary -->
      <div class="mt-6 grid grid-cols-1 sm:grid-cols-3 gap-3">
        <div class="p-3 rounded-2xl bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600">
          <p class="text-sm text-gray-600 dark:text-gray-300">合計（0–25）</p>
          <p id="score-total" class="text-2xl font-bold">0 / 25</p>
        </div>
        <div class="p-3 rounded-2xl bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600">
          <p class="text-sm text-gray-600 dark:text-gray-300">百分率（×4）</p>
          <p id="score-pct" class="text-2xl font-bold">0%</p>
        </div>
        <div class="p-3 rounded-2xl bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600">
          <p class="text-sm text-gray-600 dark:text-gray-300">前回比</p>
          <p id="score-diff" class="text-2xl font-bold">—</p>
        </div>
      </div>

      <div class="mt-4 flex flex-wrap gap-2">
        <button id="btn-save" class="flex items-center gap-2 px-4 py-3 rounded-2xl bg-black text-white text-base font-semibold">
          <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M19 21H5a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h11l5 5v9a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/></svg>
          記録を保存
        </button>
        <button id="btn-export" class="flex items-center gap-2 px-4 py-3 rounded-2xl bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600">
          <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          CSV書き出し
        </button>
        <button id="btn-clear-key" class="ml-auto px-4 py-3 rounded-2xl bg-red-50 hover:bg-red-100 text-red-700">このアプリの記録を削除</button>
      </div>
      <p class="mt-3 text-sm text-gray-600 dark:text-gray-300">※ このアプリは医療診断を目的としたものではありません。気になる症状がある場合は医療機関へご相談ください。<br>※ WHO-5の解釈（参考）：<strong>合計13点未満</strong> もしくは <strong>いずれかの設問が0または1</strong> の場合には、追加の評価（例：Major Depression Inventory）を検討します。</p>
    </section>

    <!-- Chart -->
    <section class="mt-6 bg-white dark:bg-gray-800 rounded-2xl shadow p-4">
      <div class="flex items-center gap-2 mb-2">
        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M3 3v18h18"/><path d="M19 19V9l-5 5-4-4-7 7"/></svg>
        <h2 class="text-lg font-bold">推移（WHO-5 合計）</h2>
      </div>
      <div class="w-full h-64">
        <canvas id="chart"></canvas>
      </div>
      <p id="avg-info" class="mt-2 text-sm text-gray-700 dark:text-gray-300 hidden"></p>
    </section>

    <!-- History -->
    <section class="mt-6 bg-white dark:bg-gray-800 rounded-2xl shadow p-4">
      <div class="flex items-center gap-2 mb-2">
        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        <h2 class="text-lg font-bold">履歴</h2>
      </div>
      <ul id="history" class="divide-y divide-gray-200 dark:divide-gray-700"></ul>
    </section>
  </main>

  <script>
    // ===== 定数・ストレージキー =====
    const WHO5_LABELS = [
      '明るく，楽しい気分で過ごした。',
      '落ち着いた、リラックスした気分で過ごした。',
      '意欲的で，活動的に過ごした。',
      'ぐっすりと休め，気持ちよくめざめた。',
      '日常生活の中に，興味のあることがたくさんあった。',
    ];
    const OPTIONS = ['0 まったくない','1 ほんのたまに','2 半分以下の期間を','3 半分以上の期間を','4 ほとんどいつも','5 いつも'];

    const STORAGE_KEY = 'who5_records_v3';
    const REMINDER_KEY = 'who5_next_reminder'; // ISO日付（YYYY-MM-DD）

    // ===== 要素参照 =====
    const dateEl = document.getElementById('date');
    const fieldsEl = document.getElementById('who5-fields');
    const totalEl = document.getElementById('score-total');
    const pctEl = document.getElementById('score-pct');
    const diffEl = document.getElementById('score-diff');
    const historyEl = document.getElementById('history');
    const avgInfoEl = document.getElementById('avg-info');

    const btnTheme = document.getElementById('btn-theme');
    const btnSave = document.getElementById('btn-save');
    const btnExport = document.getElementById('btn-export');
    const btnClearKey = document.getElementById('btn-clear-key');

    const reminderBar = document.getElementById('reminderBar');
    const reminderClose = document.getElementById('reminderClose');
    const reminderGo = document.getElementById('reminderGo');

    // ===== ユーティリティ =====
    const toISODate = (d) => {
      const tz = d.getTimezoneOffset() * 60000;
      return new Date(d - tz).toISOString().slice(0,10);
    };
    const addDaysISO = (iso, days) => {
      const d = new Date(iso + 'T00:00:00');
      d.setDate(d.getDate() + days);
      return toISODate(d);
    };

    function load(){
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }
      catch { return []; }
    }
    function saveAll(list){ localStorage.setItem(STORAGE_KEY, JSON.stringify(list)); }

    // ===== 入力UI =====
    function renderFields(values = [0,0,0,0,0]){
      fieldsEl.innerHTML = '';
      WHO5_LABELS.forEach((label, idx) => {
        const wrap = document.createElement('div');
        wrap.className = 'bg-gray-50 dark:bg-gray-700 rounded-2xl p-3 border border-gray-200 dark:border-gray-600';
        const selectId = `q${idx}`;
        const optionsHtml = OPTIONS.map((t,i)=>`<option value="${i}">${t}</option>`).join('');
        wrap.innerHTML = `
          <label class="block mb-1" for="${selectId}">${idx+1}. ${label}</label>
          <select id="${selectId}" class="w-full p-2 rounded-xl bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600">${optionsHtml}</select>`;
        fieldsEl.appendChild(wrap);
        document.getElementById(selectId).value = values[idx];
      });
    }

    function currentValues(){
      return WHO5_LABELS.map((_,i)=> parseInt(document.getElementById('q'+i).value));
    }
    function computeScore(vals){ return vals.reduce((a,b)=>a+b,0); }

    function updateSummary(){
      const vals = currentValues();
      const total = computeScore(vals);
      totalEl.textContent = `${total} / 25`;
      pctEl.textContent = `${total*4}%`;
      const all = load();
      const last = all.slice(-1)[0];
      diffEl.textContent = last ? `${(total - last.total) >= 0 ? '+' : ''}${total - last.total}` : '—';
    }

    // ===== 初期化 =====
    const todayISO = toISODate(new Date());
    dateEl.max = todayISO;
    dateEl.value = todayISO;
    renderFields();
    updateSummary();
    fieldsEl.addEventListener('change', updateSummary);

    // ===== チャート =====
    const chartCtx = document.getElementById('chart');
    const chart = new Chart(chartCtx, {
      type: 'line',
      data: { labels: [], datasets: [{ label: '合計スコア', data: [], tension: 0.3, pointRadius: 3, borderWidth: 2 }]},
      options: { responsive: true, scales: { y: { min: 0, max: 25 } } }
    });

    function refreshChart(){
      const all = load().slice().sort((a,b)=> a.date.localeCompare(b.date));
      chart.data.labels = all.map(r => r.date);
      chart.data.datasets[0].data = all.map(r => r.total);
      chart.update();
      // 直近7回平均
      if (all.length){
        const last7 = all.slice(-7);
        const avg = Math.round((last7.reduce((s,x)=>s+x.total,0)/last7.length)*10)/10;
        avgInfoEl.textContent = `直近${last7.length}回の平均：${avg} 点（${avg*4}%）`;
        avgInfoEl.classList.remove('hidden');
      } else {
        avgInfoEl.classList.add('hidden');
      }
    }

    function renderHistory(){
      const all = load().slice().sort((a,b)=> b.date.localeCompare(a.date));
      historyEl.innerHTML = '';
      all.forEach(rec => {
        const li = document.createElement('li');
        li.className = 'py-3 flex items-center gap-3';
        li.innerHTML = `
          <div class="flex-1">
            <p class="font-semibold">${rec.date} <span class="text-sm text-gray-600 dark:text-gray-300">（${rec.total} 点・${rec.total*4}%）</span></p>
            <p class="text-xs text-gray-600 dark:text-gray-300">[${rec.values.join(', ')}]</p>
          </div>
          <button class="px-3 py-2 rounded-xl bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-sm" data-edit>編集</button>
          <button class="px-3 py-2 rounded-2xl bg-red-50 dark:bg-red-900/30 hover:bg-red-100 dark:hover:bg-red-900/50 text-red-700 dark:text-red-300 text-sm" data-del>削除</button>`;
        // 編集
        li.querySelector('[data-edit]').addEventListener('click', () => {
          dateEl.value = rec.date;
          renderFields(rec.values);
          updateSummary();
          window.scrollTo({ top: 0, behavior: 'smooth' });
        });
        // 削除
        li.querySelector('[data-del]').addEventListener('click', () => {
          if (!confirm('この記録を削除しますか？')) return;
          const rest = load().filter(r => !(r.date === rec.date));
          saveAll(rest);
          renderHistory(); refreshChart(); updateSummary(); maybeShowReminder();
        });
        historyEl.appendChild(li);
      });
    }

    function upsertRecord(){
      const date = dateEl.value;
      const values = currentValues();
      const total = computeScore(values);
      let all = load();
      // 同日上書き
      all = all.filter(r => r.date !== date);
      all.push({ date, values, total });
      all.sort((a,b)=> a.date.localeCompare(b.date));
      saveAll(all);
      // 次回リマインドを設定（14日後）
      const next = addDaysISO(date, 14);
      localStorage.setItem(REMINDER_KEY, next);
    }

    // ===== CSV（UTF-8 BOM + CRLF） =====
    function exportCSV(){
      const all = load().slice().sort((a,b)=> a.date.localeCompare(b.date));
      if (!all.length){ alert('記録がありません'); return; }
      const header = ['日付','q1','q2','q3','q4','q5','合計','百分率'];
      const rows = all.map(r => [r.date, ...r.values, r.total, r.total*4]);
      const csv = [header, ...rows]
        .map(cols => cols.map(v => String(v).replaceAll('"','""')).map(v => /[",\n\r]/.test(v)?`"${v}"`:v).join(','))
        .join('\r\n');
      const BOM = new Uint8Array([0xEF,0xBB,0xBF]);
      const blob = new Blob([BOM, csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'who5_records.csv'; a.click();
      URL.revokeObjectURL(url);
    }

    // ===== リマインド表示（アクセス時に判定） =====
    function maybeShowReminder(){
      const all = load();
      if (!all.length){ reminderBar.classList.add('hidden'); return; }
      // 直近の記録日
      const last = all[all.length-1].date;
      // 既存の予定があれば使用、なければ直近+14日
      const next = localStorage.getItem(REMINDER_KEY) || addDaysISO(last, 14);
      localStorage.setItem(REMINDER_KEY, next);
      const today = toISODate(new Date());
      if (today >= next){
        reminderBar.classList.remove('hidden');
      } else {
        reminderBar.classList.add('hidden');
      }
    }

    // ===== イベント =====
    btnTheme.addEventListener('click', () => {
      document.documentElement.classList.toggle('dark');
      localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
    });

    btnSave.addEventListener('click', () => {
      upsertRecord();
      renderHistory(); refreshChart(); updateSummary(); maybeShowReminder();
      alert('保存しました');
    });

    btnExport.addEventListener('click', exportCSV);

    btnClearKey.addEventListener('click', () => {
      if (!confirm('このアプリの記録を全て削除します（元に戻せません）。よろしいですか？')) return;
      localStorage.removeItem(STORAGE_KEY);
      localStorage.removeItem(REMINDER_KEY);
      renderHistory(); refreshChart(); updateSummary(); maybeShowReminder();
      alert('削除しました');
    });

    reminderClose.addEventListener('click', () => reminderBar.classList.add('hidden'));
    reminderGo.addEventListener('click', () => { window.scrollTo({ top: 0, behavior: 'smooth' }); reminderBar.classList.add('hidden'); });

    // ===== 初回描画 =====
    renderHistory();
    refreshChart();
    maybeShowReminder();
  </script>
</body>
</html>
